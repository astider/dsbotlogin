<HTML>
  <head>

      <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
      <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
      <script>
        
        // Initialize Firebase
        // TODO: Replace with your project's customized code snippet
        let config = {
          apiKey: "AIzaSyAYSrsXnlBtkeGn7p7UjZAg67GQGStfuHE",
          authDomain: "dsbot-3c090.firebaseapp.com",
          databaseURL: "https://dsbot-3c090.firebaseio.com"

        }
        firebase.initializeApp(config)
      
        let provider = new firebase.auth.FacebookAuthProvider()
        
        provider.addScope('manage_pages')
        provider.addScope('business_management')
        provider.addScope('pages_show_list')
        provider.addScope('pages_messaging')
        provider.addScope('pages_messaging_subscriptions')

        provider.setCustomParameters({
          'display': 'popup'
        })
  

        let token = ''
        let user = null

        

        function loginFacebook(id) {

          console.log(`button ${id} clicked`)
          console.log(`in login function`)
          let button = document.getElementById(id)
          button.disabled = true
          button.innerHTML = "Processing ..."

          let dotter = setInterval( () => {
            button.innerHTML += '.'
          }, 500)
  
          firebase.auth().signInWithPopup(provider)
          .then(function(result) {
            
            token = result.credential.accessToken
            user = result.user
            
            return axios.get(`https://graph.facebook.com/v2.11/me/accounts?access_token=${token}`)
          })
          .then(response => {
            
            let pages = response.data.data
            let thePageToken = null
            let thePageID = null
            let thePageName = ''

            pages.map(page => {
              if (page.name === 'Nalinfa' || page.name === 'DS' || page.name === 'Gimme Android') {
                thePageToken = page.access_token
                thePageID = page.id
                thePageName = page.name
              }
            })

            // console.log(`Nalinfa token = ${thePageToken}`)

            if (thePageToken) {
              
              axios.post('https://us-central1-dsbot-3c090.cloudfunctions.net/addPageToken',
                { 
                  'token': thePageToken,
                  'id': thePageID
                }
              )
              .then(response => {
                console.log(`get response from addPageToken`)
                console.log(response)

                return axios.post('https://us-central1-dsbot-3c090.cloudfunctions.net/addPageNameToID',
                  { 
                    'name': thePageName,
                    'id': thePageID
                  }
                )

              })
              .then(response => {
                console.log(`get response from addPageNameToID`)
                console.log(response)

                return axios.post(`https://graph.facebook.com/v2.11/${thePageID}/subscribed_apps`,
                  {
                    'access_token': thePageToken
                  }
                )
              })
              .then(response => {
                let data = response.data
                console.log(`sub result : ${JSON.stringify(data)}`)
                if(data.success) {
                  console.log('subscribe success')
                  clearInterval(dotter)
                  button.innerHTML = "Success!"
                }
                else {
                  clearInterval(dotter)
                  button.innerHTML = "Fail ..."

                  throw 'subscribe to app ERROR'
                }
              })
              .catch(err => {
                console.log(`err: ${err}`)
              })

            }
            else {
              console.log(`no specified page found`)
            }
            

          })
          .catch(function(error) {
            console.log(`error`)
            
            let errorCode = error.code
            let errorMessage = error.message
            let email = error.email
            let credential = error.credential
            
            console.log(`error code ${errorCode}`)
            console.log(`error message : ${errorMessage}`)
          })
  
        }        
      
      </script>
      
  </head>
  <body>

    <br><br><br>
    <center>
      <button id="loginButton" type="button" name="button" onclick="loginFacebook(this.id)">Login ด้วย Facebook เพื่อเข้าใช้งาน Chatbot</button>
      <br><br>
      <div id="pages"></div>
    </center>
    

  </body>
</HTML>

